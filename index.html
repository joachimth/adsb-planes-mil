<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milit√¶r Fly Tracker</title>

    <!-- Eksterne CSS Biblioteker -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    
    <!-- VORES EGET, CENTRALE STYLESHEET -->
    <link rel="stylesheet" href="style.css">

</head>
<body>

    <!-- Containere for de dynamisk indl√¶ste HTML-sektioner -->
    <header id="header-container"></header>

    <main>
        <!-- N√∏d-alarmen placeres her, s√• den er en del af sidens flow -->
        <div id="emergency-alert-container"></div>
        
        <!-- Kortet er en fast del af strukturen -->
        <div id="map"></div>
        
        <!-- Filtre -->
        <div id="filter-container"></div>
        <div id="squawk-filter-container"></div>
        
        <!-- Fly-tabellen -->
        <div id="flight-table-container"></div>
    </main>

    <footer id="footer-container"></footer>


    <!-- =================================================================== -->
    <!-- JAVASCRIPT - Dirigenten og de eksterne biblioteker -->
    <!-- =================================================================== -->

    <!-- Leaflet JS (til kortet) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Vores egne JS-moduler (defer sikrer korrekt indl√¶sningsr√¶kkef√∏lge) -->
    <script src="map_section.js" defer></script>
    <script src="flight_table.js" defer></script>
    <script src="callsign_filter.js" defer></script>
    <script src="squawk_filter.js" defer></script>
    <script src="emergency_alert.js" defer></script>

    <!-- DIRIGENTEN: Hovedlogikken, der styrer alt -->
    <script>
        document.addEventListener('DOMContentLoaded', main);

        // --- GLOBALE VARIABLER (SIDENS TILSTAND) ---
        let globalFlightData = [];
        let activeCallsignFilter = '';
        let userSelectedSquawks = new Set();
        const apiProxyUrl = "https://corsproxy.io/?url=";
        const apiUrl = apiProxyUrl + encodeURIComponent("https://api.adsb.lol/v2/mil");

        /**
         * Applikationens hovedfunktion. K√∏rer n√•r siden er klar.
         */
        async function main() {
            console.log("‚úàÔ∏è DOM klar. Starter applikationen...");

            // 1. Indl√¶s alle HTML-sektioner parallelt for hastighed
            await loadAllHtmlSections();
            console.log("‚úÖ Alle HTML-sektioner indl√¶st.");

            // 2. Initialiser alle JavaScript-moduler
            await initAllJsModules();
            console.log("‚úÖ Alle JS-moduler initialiseret.");

            // 3. Hent fly-data for f√∏rste gang
            await fetchFlightData();

            // 4. Start den periodiske opdatering (hvert 30. sekund)
            setInterval(fetchFlightData, 30000);
        }

        /**
         * Indl√¶ser alle HTML-filer ind i deres respektive containere.
         */
        function loadAllHtmlSections() {
            const sections = [
                { id: 'header-container', url: 'header.html' },
                { id: 'emergency-alert-container', url: 'emergency_alert.html' },
                { id: 'filter-container', url: 'filter_section.html' },
                { id: 'squawk-filter-container', url: 'squawk_filter.html' },
                { id: 'flight-table-container', url: 'flight_table.html' },
                { id: 'footer-container', url: 'footer.html' }
            ];

            // Bruger Promise.all til at hente alt p√• samme tid
            const promises = sections.map(section => 
                fetch(section.url)
                    .then(response => {
                        if (!response.ok) throw new Error(`Kunne ikke finde ${section.url}`);
                        return response.text();
                    })
                    .then(data => {
                        const container = document.getElementById(section.id);
                        if (container) container.innerHTML = data;
                    })
                    .catch(err => console.error(`‚ùå Fejl ved indl√¶sning af sektion:`, err))
            );
            return Promise.all(promises);
        }
        
        /**
         * Kalder initialiseringsfunktionerne fra alle vores JS-moduler.
         */
        async function initAllJsModules() {
             // Funktionerne (f.eks. window.initMap) bliver defineret i de defer'ede scripts.
            if(typeof initMap === "function") initMap();
            if(typeof initializeCallsignFilter === "function") initializeCallsignFilter();
            if(typeof initializeEmergencyAlert === "function") initializeEmergencyAlert();
            
            // Squawk-filteret er asynkront, da det henter en JSON-fil, s√• vi bruger await.
            if(typeof initializeSquawkFilter === "function") {
                await initializeSquawkFilter();
            }
        }

        /**
         * Henter flydata fra API'et.
         */
        async function fetchFlightData() {
            console.log("üîÑ Henter flydata...");
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`API-fejl: ${response.status}`);
                
                const data = await response.json();
                globalFlightData = data.ac || [];
                
                console.log(`‚úÖ ${globalFlightData.length} fly hentet.`);

                // Efter data er hentet, opdateres alle visninger.
                applyFiltersAndUpdate();

            } catch (error) {
                console.error("‚ùå Kritisk fejl ved hentning af flydata:", error);
            }
        }

        /**
         * DEN CENTRALE OPDATERINGSFUNKTION
         * Anvender alle aktive filtre og opdaterer kort og tabel.
         * Denne funktion kaldes HVER gang data opdateres eller et filter √¶ndres.
         */
        function applyFiltersAndUpdate() {
            if (!globalFlightData) return;

            // 1. Tjek for n√∏d-alarmer p√• de UFILTREREDE data
            if(typeof checkAndDisplayEmergencyAlert === "function") {
                checkAndDisplayEmergencyAlert(globalFlightData);
            }

            // 2. Anvend filtre
            let filteredData = globalFlightData.filter(flight => {
                const callsign = (flight.flight || '').toLowerCase();
                const squawk = flight.squawk;

                const callsignMatch = activeCallsignFilter === '' || callsign.includes(activeCallsignFilter);
                const squawkMatch = userSelectedSquawks.size === 0 || userSelectedSquawks.has(squawk);
                
                return callsignMatch && squawkMatch;
            });

            // 3. Opdater kort og tabel med de FILTREREDE data
            if(typeof updateMap === "function") updateMap(filteredData);
            if(typeof updateFlightTable === "function") updateFlightTable(filteredData);
        }

        // G√∏r n√∏glefunktioner og variabler globale, s√• de kan tilg√•s fra de separate moduler
        window.applyFiltersAndUpdate = applyFiltersAndUpdate;
        window.activeCallsignFilter = activeCallsignFilter;
        window.userSelectedSquawks = userSelectedSquawks;

    </script>
</body>
</html>