async function getFlights() {
    const proxyUrl = "https://corsproxy.io/?url=";
    const militaryUrl = proxyUrl + encodeURIComponent("https://api.adsb.lol/v2/mil");
    let flights = [];

    try {
        let response = await fetch(militaryUrl);
        let data = await response.json();
        let militaryFlights = data.ac.filter(f => f.lat !== undefined && f.lon !== undefined);

        flights = flights.concat(militaryFlights);

        for (let squawk of selectedSquawkCodes) {
            let squawkUrl = proxyUrl + encodeURIComponent(`https://api.adsb.lol/v2/squawk/${squawk}`);
            let squawkResponse = await fetch(squawkUrl);
            let squawkData = await squawkResponse.json();
            let squawkFlights = squawkData.ac.filter(f => f.lat !== undefined && f.lon !== undefined);

            flights = flights.concat(squawkFlights);
        }

        markersLayer.clearLayers();
        document.getElementById("flightTableBody").innerHTML = "";

        let emergencyDetected = false;
        flights.forEach(f => {
            if (f.lat === undefined || f.lon === undefined) {
                console.warn(`Fly mangler koordinater og springes over:`, f);
                return; // Spring flyet over, hvis det mangler koordinater
            }

            let color = "blue";
            if (["7500", "7600", "7700", "7777", "0000"].includes(f.squawk)) {
                color = "red";
                emergencyDetected = true;
            }

            let marker = L.circleMarker([f.lat, f.lon], { radius: 6, color }).addTo(markersLayer);
            marker.bindPopup(`<b>Fly ID:</b> ${f.icao24 || "Ukendt"} <br> <b>Squawk:</b> ${f.squawk || "Ukendt"}`);

            document.getElementById("flightTableBody").innerHTML += `
                <tr>
                    <td>${f.icao24 || "Ukendt"}</td>
                    <td>${f.type || "Ukendt"}</td>
                    <td>${f.alt_baro || "N/A"}</td>
                    <td>${f.gs || "N/A"}</td>
                    <td>${f.squawk || "Ukendt"}</td>
                </tr>
            `;
        });

        if (emergencyDetected) showAlarm();
        else hideAlarm();
    } catch (error) {
        console.error("Fejl ved hentning af data:", error);
    }
}
