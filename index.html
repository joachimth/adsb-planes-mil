<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MilitÃ¦re & Civile Fly Tracker (ADSB.lol)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #map { width: 80%; height: 500px; margin: 20px auto; border: 1px solid black; }
        #countdown { font-size: 18px; margin: 10px; }
        button { padding: 10px 15px; font-size: 16px; margin: 10px; cursor: pointer; }
        
        /* Visuel alarm-styling */
        #alarmBanner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            background: red;
            color: white;
            text-align: center;
            z-index: 1000;
            animation: blink 1s infinite;
            cursor: pointer;
        }

        @keyframes blink {
            0% { background: red; }
            50% { background: darkred; }
            100% { background: red; }
        }

        /* Tabel styling */
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>

    <div id="alarmBanner" onclick="hideAlarm()">ðŸš¨ NÃ˜D-SQUAWK DETEKTERET! KLIK FOR AT SKJULE ðŸš¨</div>

    <h1>MilitÃ¦re & Civile Fly Tracker (ADSB.lol)</h1>
    <p id="countdown">Opdatering om: <span id="timer">30</span> sek.</p>
    <button id="toggleFilter">FiltrÃ©r kun nÃ¸d-squawk: <span id="filterStatus">OFF</span></button>
    <button id="toggleCivilian">Vis civile fly: <span id="civilianStatus">OFF</span></button>
    <div id="map"></div>

    <!-- Tabel til flyoversigt -->
    <h2>Synlige Fly</h2>
    <table>
        <thead>
            <tr>
                <th>Fly ID</th>
                <th>Type</th>
                <th>HÃ¸jde (ft)</th>
                <th>Hastighed (knots)</th>
                <th>Squawk</th>
            </tr>
        </thead>
        <tbody id="flightTableBody"></tbody>
    </table>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script>
        var map = L.map('map').setView([55, 10], 6); // Centreret over Danmark
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var markersLayer = L.layerGroup().addTo(map);
        var flightPaths = {}; 
        var countdown = 30;
        var filterEmergency = false;
        var showCivilian = false;

        async function getFlights() {
            let apiUrl = showCivilian 
                ? "https://api.adsb.lol/v2/aircraft"
                : "https://api.adsb.lol/v2/mil";

            try {
                let response = await fetch(apiUrl);
                let data = await response.json();

                let flights = data.ac.filter(flight => 
                    flight.lat && flight.lon &&
                    flight.lat > 35 && flight.lat < 70 &&
                    flight.lon > -25 && flight.lon < 50
                );

                if (filterEmergency) {
                    flights = flights.filter(flight => 
                        flight.squawk === "7500" || 
                        flight.squawk === "7600" || 
                        flight.squawk === "7700"
                    );
                }

                markersLayer.clearLayers();
                document.getElementById("flightTableBody").innerHTML = "";

                let emergencyDetected = false;
                let emergencyLocation = null;

                flights.forEach(flight => {
                    let flightId = flight.icao24 || "Ukendt";
                    let squawk = flight.squawk || "Normal";
                    let color = showCivilian ? "green" : "blue"; 

                    if (squawk === "7500") color = "red";   
                    if (squawk === "7600") color = "yellow"; 
                    if (squawk === "7700") color = "red";   

                    if (squawk === "7500" || squawk === "7600" || squawk === "7700") {
                        emergencyDetected = true;
                        emergencyLocation = [flight.lat, flight.lon];
                    }

                    if (!flightPaths[flightId]) {
                        flightPaths[flightId] = [];
                    }
                    flightPaths[flightId].push([flight.lat, flight.lon]);

                    if (flightPaths[flightId].length > 10) {
                        flightPaths[flightId].shift();
                    }

                    L.polyline(flightPaths[flightId], { color: color }).addTo(markersLayer);

                    let marker = L.circleMarker([flight.lat, flight.lon], {
                        radius: 6,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.8
                    }).addTo(markersLayer);

                    marker.bindPopup(`
                        <b>Fly ID:</b> ${flightId}<br>
                        <b>Type:</b> ${flight.type || "Ukendt"}<br>
                        <b>HÃ¸jde:</b> ${flight.alt_baro || "N/A"} ft<br>
                        <b>Hastighed:</b> ${flight.gs || "N/A"} knots<br>
                        <b>Squawk:</b> <span style="color: ${color}; font-weight: bold;">${squawk}</span>
                    `);

                    document.getElementById("flightTableBody").innerHTML += `
                        <tr>
                            <td>${flightId}</td>
                            <td>${flight.type || "Ukendt"}</td>
                            <td>${flight.alt_baro || "N/A"}</td>
                            <td>${flight.gs || "N/A"}</td>
                            <td>${squawk}</td>
                        </tr>
                    `;
                });

                if (emergencyDetected && emergencyLocation) {
                    showAlarm();
                    map.setView(emergencyLocation, 8);
                } else {
                    hideAlarm();
                }

            } catch (error) {
                console.error("Fejl ved hentning af data:", error);
            }
        }

        function showAlarm() { document.getElementById("alarmBanner").style.display = "block"; }
        function hideAlarm() { document.getElementById("alarmBanner").style.display = "none"; }

        getFlights();
        setInterval(() => { getFlights(); countdown = 30; }, 30000);
        setInterval(() => { if (countdown > 0) { countdown--; document.getElementById("timer").innerText = countdown; } }, 1000);
    </script>

</body>
</html>
