<script>
    let selectedSquawkCodes = new Set();

    async function loadSquawkCodes() {
        try {
            let response = await fetch("squawk_codes.json");
            let squawkData = await response.json();
            generateSquawkTable(squawkData);
        } catch (error) {
            console.error("Fejl ved hentning af squawk-koder:", error);
        }
    }

    function expandSquawkRange(code) {
        if (code.includes("-")) {
            let [start, end] = code.split("-").map(Number);
            let expandedCodes = [];
            for (let i = start; i <= end; i++) {
                expandedCodes.push(i.toString().padStart(4, "0")); // Sikrer firecifrede squawk-koder
            }
            return expandedCodes;
        }
        return [code]; // Hvis det ikke er et interval, returneres koden som en enkeltvÃ¦rdi
    }

    function generateSquawkTable(squawkData) {
        let tbody = document.getElementById("squawkTableBody");
        tbody.innerHTML = "";
        
        squawkData.forEach(s => {
            let expandedCodes = expandSquawkRange(s.code);
            
            expandedCodes.forEach(code => {
                let checked = selectedSquawkCodes.has(code) ? "checked" : "";
                let row = `<tr>
                    <td>${code}</td>
                    <td>${s.description}</td>
                    <td><input type="checkbox" data-code="${code}" ${checked}></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        });

        document.querySelectorAll("#squawkTableBody input").forEach(input => {
            input.addEventListener("change", (e) => {
                let code = e.target.dataset.code;
                if (e.target.checked) {
                    selectedSquawkCodes.add(code);
                } else {
                    selectedSquawkCodes.delete(code);
                }
                getFlights();
            });
        });
    }

    async function getFlights() {
        const proxyUrl = "https://corsproxy.io/?url=";
        let flights = [];

        try {
            for (let squawk of selectedSquawkCodes) {
                let squawkUrl = proxyUrl + encodeURIComponent(`https://api.adsb.lol/v2/squawk/${squawk}`);
                let response = await fetch(squawkUrl);
                let data = await response.json();
                flights = flights.concat(data.ac.filter(f => f.lat && f.lon));
            }

            updateFlightTable(flights);
        } catch (error) {
            console.error("Fejl ved hentning af data:", error);
        }
    }

    function updateFlightTable(flights) {
        let tbody = document.getElementById("flightTableBody");
        tbody.innerHTML = "";

        flights.forEach(f => {
            let row = `<tr>
                <td>${f.flight || "Ukendt"}</td>
                <td>${f.type || "Ukendt"}</td>
                <td>${f.alt_baro || "N/A"}</td>
                <td>${f.gs || "N/A"}</td>
                <td>${f.squawk || "Ukendt"}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    loadSquawkCodes();
</script>