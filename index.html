<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milit√¶r Fly Tracker</title>

    <!-- Eksterne biblioteker (CSS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    
    <!-- Vores egne, centrale styles -->
    <style>
        :root {
            --brand-color: #007bff;
            --danger-color: #d32f2f;
        }

        /* --- GENERELT LAYOUT --- */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
            min-height: 100vh;
            margin: 0;
            padding: 1rem 0;
            text-align: center;
        }
        main {
            width: 90%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px; /* Afstand mellem sektioner */
        }
        header, footer {
             width: 90%;
             max-width: 1200px;
             margin-top: 20px;
             text-align: center;
        }

        /* --- SEKTIONS-STYLING --- */
        section {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
        }
        h3 {
            margin-top: 0;
            color: var(--brand-color);
        }
        
        /* --- KORT --- */
        #map {
            width: 100%;
            aspect-ratio: 16 / 9; 
            max-height: 70vh; 
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        
        /* --- RESPONSIVE TABELLER --- */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        tr:last-child td {
            border-bottom: none;
        }
        #squawkTableBody .category-header td {
            font-weight: bold;
            background-color: #f8f8f8;
            padding-top: 15px;
        }

        /* --- N√òD-ALARM BOKS --- */
        #emergencyAlertBox {
            visibility: hidden; /* Skjult som standard */
            opacity: 0;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background-color: var(--danger-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 2000;
            font-size: 1.1em;
            font-weight: bold;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #emergencyAlertBox.visible {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #emergencyAlertBox .dismiss-button {
            background: none; border: none; color: white;
            font-size: 2em; line-height: 1; cursor: pointer; opacity: 0.8;
        }
        #emergencyAlertBox .dismiss-button:hover {
            opacity: 1;
        }
    </style>
</head>
<body>

    <!-- Containere for de dynamisk indl√¶ste HTML-sektioner -->
    <header id="header-container"></header>

    <main>
        <!-- N√∏d-alarmen placeres her, s√• den er en del af sidens flow -->
        <div id="emergency-alert-container"></div>
        
        <!-- Kortet er en fast del af strukturen -->
        <div id="map"></div>
        
        <!-- Filtre -->
        <div id="filter-container"></div>
        <div id="squawk-filter-container"></div>
        
        <!-- Fly-tabellen -->
        <div id="flight-table-container"></div>
    </main>

    <footer id="footer-container"></footer>


    <!-- =================================================================== -->
    <!-- JAVASCRIPT - Dirigenten og de eksterne biblioteker -->
    <!-- =================================================================== -->

    <!-- Leaflet JS (til kortet) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Vores egne JS-moduler (defer sikrer korrekt indl√¶sningsr√¶kkef√∏lge) -->
    <script src="map_section.js" defer></script>
    <script src="flight_table.js" defer></script>
    <script src="callsign_filter.js" defer></script>
    <script src="squawk_filter.js" defer></script>
    <script src="emergency_alert.js" defer></script>

    <!-- DIRIGENTEN: Hovedlogikken, der styrer alt -->
    <script>
        document.addEventListener('DOMContentLoaded', main);

        // --- GLOBALE VARIABLER (SIDENS TILSTAND) ---
        let globalFlightData = [];
        let activeCallsignFilter = '';
        let userSelectedSquawks = new Set();
        const apiProxyUrl = "https://corsproxy.io/?url=";
        const apiUrl = apiProxyUrl + encodeURIComponent("https://api.adsb.lol/v2/mil");

        /**
         * Applikationens hovedfunktion. K√∏rer n√•r siden er klar.
         */
        async function main() {
            console.log("‚úàÔ∏è DOM klar. Starter applikationen...");

            // 1. Indl√¶s alle HTML-sektioner parallelt for hastighed
            await loadAllHtmlSections();
            console.log("‚úÖ Alle HTML-sektioner indl√¶st.");

            // 2. Initialiser alle JavaScript-moduler
            initAllJsModules();
            console.log("‚úÖ Alle JS-moduler initialiseret.");

            // 3. Hent fly-data for f√∏rste gang
            await fetchFlightData();

            // 4. Start den periodiske opdatering (hvert 30. sekund)
            setInterval(fetchFlightData, 30000);
        }

        /**
         * Indl√¶ser alle HTML-filer ind i deres respektive containere.
         */
        function loadAllHtmlSections() {
            const sections = [
                { id: 'header-container', url: 'header.html' },
                { id: 'emergency-alert-container', url: 'emergency_alert.html' },
                { id: 'filter-container', url: 'filter_section.html' },
                { id: 'squawk-filter-container', url: 'squawk_filter.html' },
                { id: 'flight-table-container', url: 'flight_table.html' },
                { id: 'footer-container', url: 'footer.html' }
            ];

            // Bruger Promise.all til at hente alt p√• samme tid
            const promises = sections.map(section => 
                fetch(section.url)
                    .then(response => response.text())
                    .then(data => {
                        const container = document.getElementById(section.id);
                        if (container) container.innerHTML = data;
                    })
                    .catch(err => console.error(`‚ùå Fejl ved indl√¶sning af ${section.url}:`, err))
            );
            return Promise.all(promises);
        }
        
        /**
         * Kalder initialiseringsfunktionerne fra alle vores JS-moduler.
         */
        async function initAllJsModules() {
             // Funktionerne (f.eks. window.initMap) bliver defineret i de defer'ede scripts.
            if(typeof initMap === "function") initMap();
            if(typeof initializeCallsignFilter === "function") initializeCallsignFilter();
            if(typeof initializeEmergencyAlert === "function") initializeEmergencyAlert();
            
            // Squawk-filteret er asynkront, da det henter en JSON-fil
            if(typeof initializeSquawkFilter === "function") {
                await initializeSquawkFilter();
            }
        }

        /**
         * Henter flydata fra API'et.
         */
        async function fetchFlightData() {
            console.log("üîÑ Henter flydata...");
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`API-fejl: ${response.status}`);
                
                const data = await response.json();
                globalFlightData = data.ac || [];
                
                console.log(`‚úÖ ${globalFlightData.length} fly hentet.`);

                // Efter data er hentet, opdateres alle visninger.
                applyFiltersAndUpdate();

            } catch (error) {
                console.error("‚ùå Kritisk fejl ved hentning af flydata:", error);
            }
        }

        /**
         * DEN CENTRALE OPDATERINGSFUNKTION
         * Anvender alle aktive filtre og opdaterer kort og tabel.
         * Denne funktion kaldes HVER gang data opdateres eller et filter √¶ndres.
         */
        function applyFiltersAndUpdate() {
            if (!globalFlightData) return;

            // 1. Tjek for n√∏d-alarmer p√• de UFILTREREDE data
            if(typeof checkAndDisplayEmergencyAlert === "function") {
                checkAndDisplayEmergencyAlert(globalFlightData);
            }

            // 2. Anvend filtre
            let filteredData = globalFlightData.filter(flight => {
                const callsignMatch = !activeCallsignFilter || (flight.flight && flight.flight.toLowerCase().includes(activeCallsignFilter));
                const squawkMatch = userSelectedSquawks.size === 0 || userSelectedSquawks.has(flight.squawk);
                
                return callsignMatch && squawkMatch;
            });

            // 3. Opdater kort og tabel med de FILTREREDE data
            if(typeof updateMap === "function") updateMap(filteredData);
            if(typeof updateFlightTable === "function") updateFlightTable(filteredData);
        }

        // G√∏r funktionen global, s√• filter-modulerne kan kalde den
        window.applyFiltersAndUpdate = applyFiltersAndUpdate;
        window.activeCallsignFilter = activeCallsignFilter;
        window.userSelectedSquawks = userSelectedSquawks;

    </script>
</body>
</html>